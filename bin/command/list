#!/usr/bin/env bash

set -euo pipefail

source ${LUVER_SRC}/bin/command/util/extract_luajit_version
source ${LUVER_SRC}/bin/command/util/extract_luarocks_version

function luver_list_lua_version() {
  local tool="${1}"

  if test -d "${LUVER_DIR}/${tool}-versions"; then
    local version_dir version

    for version_dir in ${LUVER_DIR}/${tool}-versions/*; do
      version="$(basename "${version_dir}")"

      if test "${version}" = "*"; then
        continue
      fi

      echo "${version}"
    done
  fi
}

function luver_list_lua_aliasmap() {
  local -r tool="${1}"

  if test -d "${LUVER_DIR}/${tool}-aliases"; then
    local alias_dir alias version

    for alias_dir in ${LUVER_DIR}/${tool}-aliases/*; do
      alias="$(basename "${alias_dir}")"

      if test "${alias}" = "*"; then
        continue
      fi

      version="$(basename $(realpath "${alias_dir}"))"

      echo "${alias}:${version}"
    done
  fi
}

function luver_list_lua() {
  local -A map

  local current_version="$(${LUVER_SRC}/bin/command/current lua)"

  local version
  for version in $(luver_list_lua_version lua); do
    map[${version}]=""
  done

  local aliasmap alias
  for aliasmap in $(luver_list_lua_aliasmap lua); do
    alias="$(echo ${aliasmap} | cut -d: -f1)"
    version="$(echo ${aliasmap} | cut -d: -f2)"
    map[${version}]="${map[${version}]} ${alias}"
  done

  local mark=""
  for version in $(printf '%s\n' ${!map[@]} | sort); do
    if test "${version}" = "${current_version}"; then
      mark=" *"
    fi

    echo "${version}${map[${version}]}${mark}"

    mark=""
  done
}

function luver_list_luajit() {
  local -A map

  local current_version="$(${LUVER_SRC}/bin/command/current luajit)"

  for lua_version in $(luver_list_lua_version lua); do
    local version="$(extract_luajit_version "${lua_version}")"
    if ! test -z "${version}"; then
      map[${version}]=" [lua:${lua_version}]"
    fi
  done

  local mark=""
  for version in $(printf '%s\n' ${!map[@]} | sort); do
    if test "${version}" = "${current_version}"; then
      mark=" *"
    fi

    echo "${version}${map[${version}]}${mark}"

    mark=""
  done
}

function luver_list_luarocks() {
  local -A map

  local current_version="$(${LUVER_SRC}/bin/command/current luarocks)"

  for lua_version in $(luver_list_lua_version lua); do
    local version="$(extract_luarocks_version "${lua_version}")"
    if ! test -z "${version}"; then
      map[${version}]=" [lua:${lua_version}]"
    fi
  done

  local mark=""
  for version in $(printf '%s\n' ${!map[@]} | sort); do
    if test "${version}" = "${current_version}"; then
      mark=" *"
    fi

    echo "${version}${map[${version}]}${mark}"

    mark=""
  done
}

function luver_list() {
  local tool="${1:-"lua"}"
  if [[ " lua luajit luarocks " != *" ${tool} "* ]]; then
    echo "unsupported tool: ${tool}"
    exit 1
  fi

  luver_list_${tool}
}

luver_list $@
